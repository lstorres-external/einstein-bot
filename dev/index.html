<!DOCTYPE html>
<html lang="en">
  <head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Sofia V2 - DEV</title>
	<script type="text/javascript">
	  var language = "en_US";
	  var isPrivate = false;

	  function getLanguageFromQueryString() {
		const urlParams = new URLSearchParams(window.location.search);
		return urlParams.get("language") || "en_US";
	  }

	  function getIsPrivateFromQueryString() {
		const urlParams = new URLSearchParams(window.location.search);
		return urlParams.has("private");
	  }

	  function initEmbeddedMessaging() {
		try {
		  embeddedservice_bootstrap.settings.language = language;
		  document.getElementById(
			"languageInfo"
		  ).innerHTML = ` O idioma foi ajustado para: ${language} <br> Ãrea privada: ${
			isPrivate ? "Sim" : "NÃ£o"
		  }`;

		  console.log("onEmb");

		  // VariÃ¡vel para controlar se jÃ¡ detectamos o encerramento
		  let chatEnded = false;

		  // Intercepta todas as mensagens postMessage
		  window.addEventListener("message", (event) => {
			// Mostra apenas mensagens importantes (nÃ£o tudo)
			if (event.data && event.data.method === 'EMBEDDED_MESSAGING_DISPATCH_EVENT_TO_HOST') {
			  console.log("ðŸ“¨ Evento do chat:", event.data);
			  
			  // Expande o data para ver o conteÃºdo
			  if (event.data.data) {
				console.log("   Dados do evento:", event.data.data);
			  }
			}
			
			try {
			  const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
			  
			  // Verifica diferentes estruturas de dados possÃ­veis
			  const dataString = JSON.stringify(data).toLowerCase();
			  
			  // DetecÃ§Ã£o mais especÃ­fica: procura por "ended" E "chat" juntos
			  if ((dataString.includes('encerrou') && dataString.includes('chat')) || 
			      (dataString.includes('ended') && dataString.includes('chat')) ||
			      (dataString.includes('chatbot') && dataString.includes('ended')) ||
			      (dataString.includes('bot encerrou'))) {
				console.log("ðŸ”´ Mensagem de encerramento detectada no postMessage!");
				if (!chatEnded) {
				  chatEnded = true;
				  handleConversationEnded();
				}
			  }
			} catch (err) {
			  // Ignora erros silenciosamente
			}
		  }, false);

		  // Listener para quando o chat estiver pronto
		  window.addEventListener("onEmbeddedMessagingReady", () => {
			console.log("Chat pronto - monitoramento de postMessage ativo");
			
			// Verifica se minimizeWindow existe
			console.log("minimizeWindow disponÃ­vel?", typeof embeddedservice_bootstrap.minimizeWindow);
			console.log("embeddedservice_bootstrap:", embeddedservice_bootstrap);
		  });

		  function handleConversationEnded() {
			console.log("ðŸ”„ Iniciando processo de reset do chat...");
			
			// Aguarda 5 segundos para o usuÃ¡rio ver a mensagem de encerramento
			setTimeout(() => {
			  console.log("Fechando chat...");
			  console.log("embeddedservice_bootstrap estÃ¡ disponÃ­vel?", typeof embeddedservice_bootstrap);
			  console.log("minimizeWindow estÃ¡ disponÃ­vel?", typeof embeddedservice_bootstrap.minimizeWindow);
			  
			  try {
				if (embeddedservice_bootstrap) {
				  if (embeddedservice_bootstrap.minimizeWindow) {
					embeddedservice_bootstrap.minimizeWindow();
					console.log("âœ… minimizeWindow() chamado");
				  } else {
					console.log("âŒ minimizeWindow nÃ£o existe - tentando alternativas");
					// Tenta alternativas
					if (typeof embeddedservice_bootstrap.minimize === 'function') {
					  embeddedservice_bootstrap.minimize();
					  console.log("âœ… minimize() chamado");
					} else {
					  console.log("âŒ Nenhuma funÃ§Ã£o de minimizar encontrada");
					  console.log("FunÃ§Ãµes disponÃ­veis:", Object.keys(embeddedservice_bootstrap));
					}
				  }
				  
				  // Reseta a flag apÃ³s 2 segundos
				  setTimeout(() => {
					chatEnded = false;
					console.log("Sistema resetado para nova conversa");
				  }, 2000);
				}
			  } catch (err) {
				console.error("Erro ao minimizar chat:", err);
			  }
			}, 5000); // 5 segundos apÃ³s detectar o encerramento
		  }

		  if (isPrivate) {
			window.addEventListener("onEmbeddedMessagingReady", (e) => {
			  console.log("iniciando prechatAPI hidden");
			  embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields({
				Language: language,
				Source: "Source",
				IsPrivatePortal: "True",
				Credit_Card_Token: "421978XvpOtd4301",
				BIN_Number: "4219788128", 
				//encrypted token
				Encrypted_ID_Token_P1:
				  "exemple1",
				Encrypted_ID_Token_P2:
				  "exemple2",
				Encrypted_ID_Token_P3:
				  "exemple3",
				Encrypted_ID_Token_P4:
				  "exemple4",
				Encrypted_ID_Token_P5:
				  "exemple5",
				Encrypted_ID_Token_P6:
				  "exemple6",
				Encrypted_ID_Token_P7:
				  "exemple7",
				Encrypted_ID_Token_P8:
				  "exemple8",
				Encrypted_ID_Token_P9:
				  "exemple9",
				Encrypted_ID_Token_P10:
				  "exemple10",
				Encrypted_ID_Token_P11:
				  "exemple11",
				Encrypted_ID_Token_P12:
				  "exemple12",
				Encrypted_ID_Token_P13:
				  "exemple13",
				Encrypted_ID_Token_P14:
				  "exemple14",
				Encrypted_ID_Token_P15:
				  "exemple15",
				Encrypted_ID_Token_P16:
				  "exemple16",
				Encrypted_ID_Token_P17:
				  "exemple17",
				Encrypted_ID_Token_P18:
				  "exemple18",
				Encrypted_ID_Token_P19:
				  "exemple19",
				Encrypted_ID_Token_P20:
				  "exemple20",
			
			  });
			});

			embeddedservice_bootstrap.init(
				'00DbY00000FgXq9',
				'Sofia_Private_Portal',
				'https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofiaPrivatePortal1762885941878',
				{
					scrt2URL: 'https://visa-gateway--dev2025.sandbox.my.salesforce-scrt.com'
				}
			);
		  } else {
			if (language == "es") {
				embeddedservice_bootstrap.init(
					'00DbY00000FgXq9',
					'Sofia_Public_Portal_ES',
					'https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofiaPublicPortalES1762885700907',
					{
						scrt2URL: 'https://visa-gateway--dev2025.sandbox.my.salesforce-scrt.com'
					}
				);
			}
			//pt_BR
			else if (language == "pt_BR") {
				embeddedservice_bootstrap.init(
					'00DbY00000FgXq9',
					'Sofia_Public_Portal_PT',
					'https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofiaPublicPortalPT1762885809583',
					{
						scrt2URL: 'https://visa-gateway--dev2025.sandbox.my.salesforce-scrt.com'
					}
				);
			}
			//en_US
			else {
				embeddedservice_bootstrap.init(
					'00DbY00000FgXq9',
					'Sofia_Public_Portal',
					'https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofia1746619645236',
					{
						scrt2URL: 'https://visa-gateway--dev2025.sandbox.my.salesforce-scrt.com'
					}
				);
			}
		  }
		} catch (err) {
		  console.error("Error loading Embedded Messaging: ", err);
		}
	  }

	  function loadBootstrapAndInit() {
		language = getLanguageFromQueryString();
		isPrivate = getIsPrivateFromQueryString();
		
		//en_US
		var scriptSrc =
		  "https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofia1746619645236/assets/js/bootstrap.min.js";
		if (isPrivate) {
		  scriptSrc =
			"https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofiaPrivatePortal1762885941878/assets/js/bootstrap.min.js";
		} else if (language == "es") {
		  scriptSrc = 
		"https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofiaPublicPortalES1762885700907/assets/js/bootstrap.min.js";
		} else if (language == "pt_BR") {
		  scriptSrc =
			"https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofiaPublicPortalPT1762885809583/assets/js/bootstrap.min.js";
		}

		var s = document.createElement("script");
		s.type = "text/javascript";
		s.src = scriptSrc;

		s.onload = function () {
		  initEmbeddedMessaging();
		};
		document.head.appendChild(s);
	  }

	  document.addEventListener("DOMContentLoaded", loadBootstrapAndInit);
	</script>
  </head>
  <body>
	<div style="margin: 10px; text-align: center">
	  <button
		onclick="window.location.href = 'https://lstorres-external.github.io/einstein-bot/dev/?language=en_US';"
	  >
		English (US)
	  </button>
	  <button
		onclick="window.location.href = 'https://lstorres-external.github.io/einstein-bot/dev/?language=pt_BR';"
	  >
		PortuguÃªs (BR)
	  </button>
	  <button
		onclick="window.location.href = 'https://lstorres-external.github.io/einstein-bot/dev/?language=es';"
	  >
		EspaÃ±ol (ES)
	  </button>
	</div>

	<div style="margin: 10px; text-align: center">
	  <button onclick="togglePrivateParam()">Toggle Private</button>
	  <button onclick="reloadWithCurrentParams()">Recarregar</button>
	</div>

	<div style="text-align: center; margin-top: 20px">
	  <p id="languageInfo"></p>
	</div>

	<script>
	  function togglePrivateParam() {
		const url = new URL(window.location.href);
		if (url.searchParams.has("private")) {
		  url.searchParams.delete("private");
		} else {
		  url.searchParams.set("private", "1");
		}
		window.location.href = url.toString();
	  }

	  function reloadWithCurrentParams() {
		window.location.reload();
	  }
	</script>
  </body>
</html>
