<!DOCTYPE html>
<html lang="en">
  <head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Sofia V2 - DEV</title>
	<script type="text/javascript">
	  var language = "en_US";
	  var isPrivate = false;

	  function getLanguageFromQueryString() {
		const urlParams = new URLSearchParams(window.location.search);
		return urlParams.get("language") || "en_US";
	  }

	  function getIsPrivateFromQueryString() {
		const urlParams = new URLSearchParams(window.location.search);
		return urlParams.has("private");
	  }

	  function initEmbeddedMessaging() {
		try {
		  embeddedservice_bootstrap.settings.language = language;
		  document.getElementById(
			"languageInfo"
		  ).innerHTML = ` O idioma foi ajustado para: ${language} <br> Ãrea privada: ${
			isPrivate ? "Sim" : "NÃ£o"
		  }`;

		  console.log("onEmb");

		  // VariÃ¡vel para controlar se jÃ¡ detectamos o encerramento
		  let chatEnded = false;

		  // Evento oficial: Detecta quando a sessÃ£o Ã© encerrada
		  window.addEventListener("onEmbeddedMessagingSessionStatusUpdate", (event) => {
			console.log("ðŸ“Š onEmbeddedMessagingSessionStatusUpdate disparado:", event.detail);
			
			try {
			  const data = event.detail;
			  
			  // Detecta SessionStatusChanged (encerramento de sessÃ£o)
			  if (data && data.conversationEntry && data.conversationEntry.entryType === 'SessionStatusChanged') {
				const payload = JSON.parse(data.conversationEntry.entryPayload);
				console.log("ðŸ“Š SessionStatusChanged:", payload.sessionStatus);
				
				if (payload.sessionStatus === 'Ended') {
				  console.log("ðŸ”´ SessÃ£o encerrada detectada!");
				  if (!chatEnded) {
					chatEnded = true;
					handleConversationEnded();
				  }
				}
			  }
			} catch (err) {
			  console.error("Erro ao processar evento:", err);
			}
		  });

		  // Listener para quando o chat estiver pronto
		  window.addEventListener("onEmbeddedMessagingReady", () => {
			console.log("âœ… Chat pronto - eventos de encerramento configurados");
			console.log("MÃ©todos disponÃ­veis:", Object.keys(embeddedservice_bootstrap));
		  });

		  function handleConversationEnded() {
			console.log("ï¿½ SessÃ£o encerrada - mantendo chat visÃ­vel com input bloqueado");
			
			// NÃ£o fazemos nada - o Salesforce jÃ¡ bloqueia o input automaticamente
			// quando a sessÃ£o termina. Deixamos o chat aberto para o usuÃ¡rio ver o histÃ³rico.
			
			// Reseta a flag apÃ³s 1 segundo
			setTimeout(() => {
			  chatEnded = false;
			  console.log("âœ… Flag resetada para detectar prÃ³xima conversa");
			}, 1000);
		  }

		  if (isPrivate) {
			window.addEventListener("onEmbeddedMessagingReady", (e) => {
			  console.log("iniciando prechatAPI hidden");
			  embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields({
				Language: language,
				Source: "Source",
				IsPrivatePortal: "True",
				Credit_Card_Token: "421978XvpOtd4301",
				BIN_Number: "4219788128", 
				//encrypted token
				Encrypted_ID_Token_P1:
				  "exemple1",
				Encrypted_ID_Token_P2:
				  "exemple2",
				Encrypted_ID_Token_P3:
				  "exemple3",
				Encrypted_ID_Token_P4:
				  "exemple4",
				Encrypted_ID_Token_P5:
				  "exemple5",
				Encrypted_ID_Token_P6:
				  "exemple6",
				Encrypted_ID_Token_P7:
				  "exemple7",
				Encrypted_ID_Token_P8:
				  "exemple8",
				Encrypted_ID_Token_P9:
				  "exemple9",
				Encrypted_ID_Token_P10:
				  "exemple10",
				Encrypted_ID_Token_P11:
				  "exemple11",
				Encrypted_ID_Token_P12:
				  "exemple12",
				Encrypted_ID_Token_P13:
				  "exemple13",
				Encrypted_ID_Token_P14:
				  "exemple14",
				Encrypted_ID_Token_P15:
				  "exemple15",
				Encrypted_ID_Token_P16:
				  "exemple16",
				Encrypted_ID_Token_P17:
				  "exemple17",
				Encrypted_ID_Token_P18:
				  "exemple18",
				Encrypted_ID_Token_P19:
				  "exemple19",
				Encrypted_ID_Token_P20:
				  "exemple20",
			
			  });
			});

			embeddedservice_bootstrap.init(
				'00DbY00000FgXq9',
				'Sofia_Private_Portal',
				'https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofiaPrivatePortal1762885941878',
				{
					scrt2URL: 'https://visa-gateway--dev2025.sandbox.my.salesforce-scrt.com'
				}
			);
		  } else {
			if (language == "es") {
				embeddedservice_bootstrap.init(
					'00DbY00000FgXq9',
					'Sofia_Public_Portal_ES',
					'https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofiaPublicPortalES1762885700907',
					{
						scrt2URL: 'https://visa-gateway--dev2025.sandbox.my.salesforce-scrt.com'
					}
				);
			}
			//pt_BR
			else if (language == "pt_BR") {
				embeddedservice_bootstrap.init(
					'00DbY00000FgXq9',
					'Sofia_Public_Portal_PT',
					'https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofiaPublicPortalPT1762885809583',
					{
						scrt2URL: 'https://visa-gateway--dev2025.sandbox.my.salesforce-scrt.com'
					}
				);
			}
			//en_US
			else {
				embeddedservice_bootstrap.init(
					'00DbY00000FgXq9',
					'Sofia_Public_Portal',
					'https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofia1746619645236',
					{
						scrt2URL: 'https://visa-gateway--dev2025.sandbox.my.salesforce-scrt.com'
					}
				);
			}
		  }
		} catch (err) {
		  console.error("Error loading Embedded Messaging: ", err);
		}
	  }

	  function loadBootstrapAndInit() {
		language = getLanguageFromQueryString();
		isPrivate = getIsPrivateFromQueryString();
		
		//en_US
		var scriptSrc =
		  "https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofia1746619645236/assets/js/bootstrap.min.js";
		if (isPrivate) {
		  scriptSrc =
			"https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofiaPrivatePortal1762885941878/assets/js/bootstrap.min.js";
		} else if (language == "es") {
		  scriptSrc = 
		"https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofiaPublicPortalES1762885700907/assets/js/bootstrap.min.js";
		} else if (language == "pt_BR") {
		  scriptSrc =
			"https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofiaPublicPortalPT1762885809583/assets/js/bootstrap.min.js";
		}

		var s = document.createElement("script");
		s.type = "text/javascript";
		s.src = scriptSrc;

		s.onload = function () {
		  initEmbeddedMessaging();
		};
		document.head.appendChild(s);
	  }

	  document.addEventListener("DOMContentLoaded", loadBootstrapAndInit);
	</script>
  </head>
  <body>
	<div style="margin: 10px; text-align: center">
	  <button
		onclick="window.location.href = 'https://lstorres-external.github.io/einstein-bot/dev/?language=en_US';"
	  >
		English (US)
	  </button>
	  <button
		onclick="window.location.href = 'https://lstorres-external.github.io/einstein-bot/dev/?language=pt_BR';"
	  >
		PortuguÃªs (BR)
	  </button>
	  <button
		onclick="window.location.href = 'https://lstorres-external.github.io/einstein-bot/dev/?language=es';"
	  >
		EspaÃ±ol (ES)
	  </button>
	</div>

	<div style="margin: 10px; text-align: center">
	  <button onclick="togglePrivateParam()">Toggle Private</button>
	  <button onclick="reloadWithCurrentParams()">Recarregar</button>
	</div>

	<div style="text-align: center; margin-top: 20px">
	  <p id="languageInfo"></p>
	</div>

	<script>
	  function togglePrivateParam() {
		const url = new URL(window.location.href);
		if (url.searchParams.has("private")) {
		  url.searchParams.delete("private");
		} else {
		  url.searchParams.set("private", "1");
		}
		window.location.href = url.toString();
	  }

	  function reloadWithCurrentParams() {
		window.location.reload();
	  }
	</script>
  </body>
</html>
