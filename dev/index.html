<!DOCTYPE html>
<html lang="en">
  <head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Sofia V2 - DEV</title>
	<script type="text/javascript">
	  var language = "en_US";
	  var isPrivate = false;

	  function getLanguageFromQueryString() {
		const urlParams = new URLSearchParams(window.location.search);
		return urlParams.get("language") || "en_US";
	  }

	  function getIsPrivateFromQueryString() {
		const urlParams = new URLSearchParams(window.location.search);
		return urlParams.has("private");
	  }

	  function initEmbeddedMessaging() {
		try {
		  embeddedservice_bootstrap.settings.language = language;
		  document.getElementById(
			"languageInfo"
		  ).innerHTML = ` O idioma foi ajustado para: ${language} <br> Ãrea privada: ${
			isPrivate ? "Sim" : "NÃ£o"
		  }`;

		  console.log("onEmb");

		  // Listener para quando o chat estiver pronto
		  window.addEventListener("onEmbeddedMessagingReady", () => {
			console.log("Chat pronto - aguardando interaÃ§Ã£o para detectar encerramento");
			
			// Tenta adicionar todos os eventos possÃ­veis para debugging
			const possibleEvents = [
			  'onEmbeddedMessagingConversationEnded',
			  'afterDestroy',
			  'afterMinimize',
			  'onEmbeddedMessagingEndOfConversation',
			  'embeddedservice:conversationEnded',
			  'conversationEnded'
			];
			
			possibleEvents.forEach(eventName => {
			  window.addEventListener(eventName, (e) => {
				console.log(`âœ… Evento detectado: ${eventName}`, e);
				handleConversationEnded();
			  });
			});
			
			// Monitora mudanÃ§as no localStorage que o Salesforce pode usar
			let lastStorageData = null;
			let conversationStarted = false;
			
			const originalSetItem = localStorage.setItem;
			localStorage.setItem = function(key, value) {
			  console.log('LocalStorage change:', key, value);
			  
			  // Detecta quando a conversa inicia (JWT Ã© criado)
			  if (key.includes('WEB_STORAGE') && value.includes('JWT')) {
				const data = JSON.parse(value);
				if (data.JWT && !conversationStarted) {
				  conversationStarted = true;
				  console.log('ðŸŸ¢ Conversa iniciada detectada');
				}
				lastStorageData = data;
			  }
			  
			  originalSetItem.apply(this, arguments);
			};
			
			// Monitora remoÃ§Ã£o de itens do localStorage
			const originalRemoveItem = localStorage.removeItem;
			localStorage.removeItem = function(key) {
			  console.log('LocalStorage removed:', key);
			  if (key.includes('WEB_STORAGE') && conversationStarted) {
				console.log('ðŸ”´ Conversa pode ter sido encerrada (storage removido)');
				conversationStarted = false;
				handleConversationEnded();
			  }
			  originalRemoveItem.apply(this, arguments);
			};
			
			// Verifica periodicamente se o JWT expirou ou foi removido
			let checkCount = 0;
			setInterval(() => {
			  const storageKey = Object.keys(localStorage).find(k => k.includes('WEB_STORAGE'));
			  if (storageKey) {
				try {
				  const currentData = JSON.parse(localStorage.getItem(storageKey));
				  
				  // Se tinha JWT e agora nÃ£o tem mais, conversa encerrada
				  if (conversationStarted && lastStorageData && lastStorageData.JWT && !currentData.JWT) {
					console.log('ðŸ”´ JWT removido - conversa encerrada');
					conversationStarted = false;
					handleConversationEnded();
				  }
				  
				  lastStorageData = currentData;
				} catch (err) {
				  // Ignora erros de parse
				}
			  } else if (conversationStarted) {
				// Storage foi completamente removido
				console.log('ðŸ”´ Storage completo removido - conversa encerrada');
				conversationStarted = false;
				handleConversationEnded();
			  }
			  
			  // Log de debug a cada 20 segundos
			  checkCount++;
			  if (checkCount % 10 === 0) {
				console.log('Status:', conversationStarted ? 'Conversa ativa' : 'Sem conversa');
			  }
			}, 2000);
			
			// Adiciona botÃ£o customizado para encerrar e resetar
			setTimeout(() => {
			  addResetButton();
			}, 2000);
		  });
		  
		  function addResetButton() {
			// Cria um botÃ£o flutuante para resetar manualmente
			const resetBtn = document.createElement('button');
			resetBtn.innerHTML = 'ðŸ”„ Resetar Chat';
			resetBtn.style.cssText = `
			  position: fixed;
			  bottom: 100px;
			  right: 20px;
			  z-index: 9999;
			  background: #ff5722;
			  color: white;
			  border: none;
			  padding: 12px 20px;
			  border-radius: 25px;
			  font-weight: bold;
			  cursor: pointer;
			  box-shadow: 0 4px 6px rgba(0,0,0,0.3);
			  display: none;
			`;
			
			resetBtn.onclick = () => {
			  console.log("BotÃ£o de reset clicado");
			  handleConversationEnded();
			};
			
			document.body.appendChild(resetBtn);
			
			// Mostra o botÃ£o apenas quando o chat estiver aberto
			const checkChatState = setInterval(() => {
			  const chatFrame = document.querySelector('iframe[title*="chat" i], iframe[class*="messaging" i]');
			  if (chatFrame && chatFrame.style.display !== 'none') {
				resetBtn.style.display = 'block';
			  } else {
				resetBtn.style.display = 'none';
			  }
			}, 500);
		  }

		  function handleConversationEnded() {
			console.log("Iniciando processo de fechamento do chat...");
			
			// Aguarda 2 segundos
			setTimeout(() => {
			  console.log("Fechando chat...");
			  try {
				if (embeddedservice_bootstrap && embeddedservice_bootstrap.minimizeWindow) {
				  embeddedservice_bootstrap.minimizeWindow();
				  console.log("Chat minimizado com sucesso");
				  
				  // Limpa o localStorage relacionado ao chat para forÃ§ar reset
				  setTimeout(() => {
					try {
					  Object.keys(localStorage).forEach(key => {
						if (key.includes('EMBEDDED_MESSAGING') || 
						    key.includes('embeddedService') ||
						    key.includes('conversation')) {
						  console.log("Limpando:", key);
						  localStorage.removeItem(key);
						}
					  });
					  console.log("âœ… Chat resetado - prÃ³xima conversa serÃ¡ uma nova sessÃ£o");
					} catch (err) {
					  console.log("Erro ao limpar localStorage:", err);
					}
				  }, 500);
				}
			  } catch (err) {
				console.error("Erro ao minimizar chat:", err);
			  }
			}, 2000);
		  }

		  if (isPrivate) {
			window.addEventListener("onEmbeddedMessagingReady", (e) => {
			  console.log("iniciando prechatAPI hidden");
			  embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields({
				Language: language,
				Source: "Source",
				IsPrivatePortal: "True",
				Credit_Card_Token: "421978XvpOtd4301",
				BIN_Number: "4219788128", 
				//encrypted token
				Encrypted_ID_Token_P1:
				  "exemple1",
				Encrypted_ID_Token_P2:
				  "exemple2",
				Encrypted_ID_Token_P3:
				  "exemple3",
				Encrypted_ID_Token_P4:
				  "exemple4",
				Encrypted_ID_Token_P5:
				  "exemple5",
				Encrypted_ID_Token_P6:
				  "exemple6",
				Encrypted_ID_Token_P7:
				  "exemple7",
				Encrypted_ID_Token_P8:
				  "exemple8",
				Encrypted_ID_Token_P9:
				  "exemple9",
				Encrypted_ID_Token_P10:
				  "exemple10",
				Encrypted_ID_Token_P11:
				  "exemple11",
				Encrypted_ID_Token_P12:
				  "exemple12",
				Encrypted_ID_Token_P13:
				  "exemple13",
				Encrypted_ID_Token_P14:
				  "exemple14",
				Encrypted_ID_Token_P15:
				  "exemple15",
				Encrypted_ID_Token_P16:
				  "exemple16",
				Encrypted_ID_Token_P17:
				  "exemple17",
				Encrypted_ID_Token_P18:
				  "exemple18",
				Encrypted_ID_Token_P19:
				  "exemple19",
				Encrypted_ID_Token_P20:
				  "exemple20",
			
			  });
			});

			embeddedservice_bootstrap.init(
				'00DbY00000FgXq9',
				'Sofia_Private_Portal',
				'https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofiaPrivatePortal1762885941878',
				{
					scrt2URL: 'https://visa-gateway--dev2025.sandbox.my.salesforce-scrt.com'
				}
			);
		  } else {
			if (language == "es") {
				embeddedservice_bootstrap.init(
					'00DbY00000FgXq9',
					'Sofia_Public_Portal_ES',
					'https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofiaPublicPortalES1762885700907',
					{
						scrt2URL: 'https://visa-gateway--dev2025.sandbox.my.salesforce-scrt.com'
					}
				);
			}
			//pt_BR
			else if (language == "pt_BR") {
				embeddedservice_bootstrap.init(
					'00DbY00000FgXq9',
					'Sofia_Public_Portal_PT',
					'https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofiaPublicPortalPT1762885809583',
					{
						scrt2URL: 'https://visa-gateway--dev2025.sandbox.my.salesforce-scrt.com'
					}
				);
			}
			//en_US
			else {
				embeddedservice_bootstrap.init(
					'00DbY00000FgXq9',
					'Sofia_Public_Portal',
					'https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofia1746619645236',
					{
						scrt2URL: 'https://visa-gateway--dev2025.sandbox.my.salesforce-scrt.com'
					}
				);
			}
		  }
		} catch (err) {
		  console.error("Error loading Embedded Messaging: ", err);
		}
	  }

	  function loadBootstrapAndInit() {
		language = getLanguageFromQueryString();
		isPrivate = getIsPrivateFromQueryString();
		
		//en_US
		var scriptSrc =
		  "https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofia1746619645236/assets/js/bootstrap.min.js";
		if (isPrivate) {
		  scriptSrc =
			"https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofiaPrivatePortal1762885941878/assets/js/bootstrap.min.js";
		} else if (language == "es") {
		  scriptSrc = 
		"https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofiaPublicPortalES1762885700907/assets/js/bootstrap.min.js";
		} else if (language == "pt_BR") {
		  scriptSrc =
			"https://visa-gateway--dev2025.sandbox.my.site.com/ESWSofiaPublicPortalPT1762885809583/assets/js/bootstrap.min.js";
		}

		var s = document.createElement("script");
		s.type = "text/javascript";
		s.src = scriptSrc;

		s.onload = function () {
		  initEmbeddedMessaging();
		};
		document.head.appendChild(s);
	  }

	  document.addEventListener("DOMContentLoaded", loadBootstrapAndInit);
	</script>
  </head>
  <body>
	<div style="margin: 10px; text-align: center">
	  <button
		onclick="window.location.href = 'https://lstorres-external.github.io/einstein-bot/dev/?language=en_US';"
	  >
		English (US)
	  </button>
	  <button
		onclick="window.location.href = 'https://lstorres-external.github.io/einstein-bot/dev/?language=pt_BR';"
	  >
		PortuguÃªs (BR)
	  </button>
	  <button
		onclick="window.location.href = 'https://lstorres-external.github.io/einstein-bot/dev/?language=es';"
	  >
		EspaÃ±ol (ES)
	  </button>
	</div>

	<div style="margin: 10px; text-align: center">
	  <button onclick="togglePrivateParam()">Toggle Private</button>
	  <button onclick="reloadWithCurrentParams()">Recarregar</button>
	</div>

	<div style="text-align: center; margin-top: 20px">
	  <p id="languageInfo"></p>
	</div>

	<script>
	  function togglePrivateParam() {
		const url = new URL(window.location.href);
		if (url.searchParams.has("private")) {
		  url.searchParams.delete("private");
		} else {
		  url.searchParams.set("private", "1");
		}
		window.location.href = url.toString();
	  }

	  function reloadWithCurrentParams() {
		window.location.reload();
	  }
	</script>
  </body>
</html>
